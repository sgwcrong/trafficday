<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>포인트/코인 관리 (관리자용)</title>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; display: flex; justify-content: center; align-items: flex-start; min-height: 100vh; background-color: #e0f7fa; margin: 0; padding-top: 30px; }
        .container { background-color: #ffffff; padding: 40px; border-radius: 12px; box-shadow: 0 6px 20px rgba(0,0,0,0.1); width: 100%; max-width: 580px; text-align: center; }
        h1 { color: #00796b; margin-bottom: 25px; font-size: 1.8em; }
        
        input[type="text"], input[type="tel"], input[type="number"], select {
            width: calc(100% - 24px); padding: 14px; margin: 8px 0; border: 1px solid #b2dfdb; border-radius: 8px; box-sizing: border-box; font-size: 1.0em;
        }
        .main-button {
            background-color: #00796b; color: white; padding: 15px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em;
            transition: background-color 0.3s ease; width: 100%; margin-top: 15px;
        }
        .main-button:hover { background-color: #004d40; }

        #adminLoginForm, #adminPanel { display: none; } /* 초기에는 둘 다 숨김 */
        #adminLoginForm.active, #adminPanel.active { display: block; }

        #adminLoginForm h2, #adminPanel h2 { color: #00796b; margin-bottom: 20px; }
        
        #userInfoInputForm { margin-bottom: 25px; border-top: 1px solid #e0e0e0; padding-top: 20px; margin-top: 20px; }
        #userDataSection {
            margin-top: 30px; padding: 25px; background-color: #e0f7fa; border-radius: 10px;
            text-align: left; display: none; /* 초기에는 숨김 */
        }
        #userDataSection h2 { color: #00796b; margin-bottom: 18px; border-bottom: 1px solid #b2dfdb; padding-bottom: 12px; font-size: 1.5em; }
        #userDataSection p { margin: 10px 0; font-size: 1.1em; }
        #userDataSection span { font-weight: bold; color: #004d40; }

        #updateForm { margin-top: 25px; padding-top: 20px; border-top: 1px solid #b2dfdb; }
        #updateForm h2 { color: #fbc02d; margin-bottom: 18px; font-size: 1.5em; }
        .add-input {
            width: calc(100% - 24px); padding: 14px; margin: 8px 0; border: 1px solid #ffeb3b; border-radius: 8px; box-sizing: border-box; font-size: 1.0em;
        }
        .update-button {
            background-color: #fbc02d; color: white; padding: 15px 25px; border: none; border-radius: 8px; cursor: pointer; font-size: 1.1em;
            transition: background-color 0.3s ease; width: 100%; margin-top: 15px;
        }
        .update-button:hover { background-color: #f9a825; }
        #message { margin-top: 15px; font-weight: bold; font-size: 1.0em; }
        #updateMessage { margin-top: 15px; font-weight: bold; font-size: 1.0em; }

        #adminLogoutButton {
            background-color: #e57373;
            margin-top: 30px;
        }
        #adminLogoutButton:hover {
            background-color: #d32f2f;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>포인트/코인 관리 (관리자용)</h1>

        <!-- 관리자 로그인 폼 (초기 화면) -->
        <div id="adminLoginForm" class="active">
            <h2>관리자 로그인</h2>
            <input type="text" id="adminNameInput" placeholder="관리자 이름을 입력하세요">
            <input type="tel" id="adminPhoneInput" pattern="[0-9]{8}" maxlength="8" placeholder="관리자 비밀번호 8자리">
            <button class="main-button" onclick="handleAdminLogin()">로그인</button>
            <p id="adminLoginMessage" class="message"></p>
        </div>

        <!-- 관리자 패널 (로그인 성공 후 표시) -->
        <div id="adminPanel">
            <p id="welcomeAdminMessage"></p>

            <div id="userInfoInputForm">
                <h2>사용자 정보 조회</h2>
                <input type="text" id="queryNameInput" placeholder="사용자 이름을 입력하세요">
                <input type="tel" id="queryPhoneInput" pattern="[0-9]{8}" maxlength="8" placeholder="사용자 전화번호 8자리">
                <button class="main-button" onclick="fetchUserData()">사용자 정보 불러오기</button>
                <p id="message"></p>
            </div>

            <div id="userDataSection">
                <h2>사용자 정보</h2>
                <p>이름: <span id="displayUserName"></span></p>
                <p>비밀번호: <span id="displayUserPhone"></span></p>
                <p>현재 포인트: <span id="displayUserPoints"></span></p>
                <p>현재 코인: <span id="displayUserCoins"></span></p>
                <p>관리자 여부: <span id="displayIsAdmin"></span></p>

                <div id="updateForm">
                    <h2>포인트/코인 추가/차감 및 관리자 설정</h2>
                    <input type="number" id="addPointsInput" class="add-input" placeholder="포인트 추가/차감할 양 (예: 100, -50)">
                    <input type="number" id="addCoinsInput" class="add-input" placeholder="코인 추가/차감할 양 (예: 5, -2)">
                    
                    <select id="adminStatusSelect">
                        <option value="">관리자 여부 선택</option>
                        <option value="YES">YES</option>
                        <option value="NO">NO</option>
                    </select>
                    
                    <button class="update-button" onclick="updateUserStats()">정보 수정하기</button>
                    <p id="updateMessage"></p>
                </div>
            </div>
            <button class="main-button" id="adminLogoutButton" onclick="handleAdminLogout()">로그아웃</button>
        </div>
    </div>

    <script>
        const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzjz-6dz2HdFNoct4lLKQAuCyw4kb2IIHuSSAic9Cp3Yf7DKZ5p8SL6xDDo468ACK8gQw/exec';
        
        // 현재 조회된 사용자 정보 (Scanner용)
        let currentUserName = null;
        let currentUserPhone = null;
        let currentUserPoints = 0;
        let currentUserCoins = 0;
        let currentIsAdmin = 'NO';

        // 현재 로그인한 관리자 정보 (Scanner용)
        let adminLoggedInUser = null; 

        document.addEventListener('DOMContentLoaded', () => {
            // 초기에는 관리자 로그인 폼만 활성화
            document.getElementById('adminLoginForm').classList.add('active');
            document.getElementById('adminPanel').classList.remove('active');
        });

        // 관리자 로그인 처리
        async function handleAdminLogin() {
            const name = document.getElementById('adminNameInput').value.trim();
            const phone = document.getElementById('adminPhoneInput').value.trim();
            const messageElement = document.getElementById('adminLoginMessage');
            messageElement.textContent = '';

            if (!name || !phone || phone.length !== 8 || !/^[0-9]+$/.test(phone)) {
                messageElement.style.color = '#d32f2f';
                messageElement.textContent = '이름과 전화번호 8자리를 정확히 입력해주세요.';
                return;
            }

            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: `action=login&name=${encodeURIComponent(name)}&phone=${encodeURIComponent(phone)}`
                });
                const result = await response.json();

                if (result.status === 'success' && result.data.isAdmin === 'YES') {
                    adminLoggedInUser = result.data; // 관리자 정보 저장
                    messageElement.style.color = '#2e7d32';
                    messageElement.textContent = `관리자 (${adminLoggedInUser.name})님, 환영합니다!`;
                    
                    // 관리자 로그인 폼 숨기고, 관리자 패널 표시
                    document.getElementById('adminLoginForm').classList.remove('active');
                    document.getElementById('adminPanel').classList.add('active');
                    document.getElementById('welcomeAdminMessage').textContent = `환영합니다, ${adminLoggedInUser.name} 관리자님!`;

                } else if (result.status === 'success' && result.data.isAdmin === 'NO') {
                    messageElement.style.color = '#d32f2f';
                    messageElement.textContent = '관리자 계정이 아닙니다. 접근 권한이 없습니다.';
                } else {
                    messageElement.style.color = '#d32f2f';
                    messageElement.textContent = result.message || '로그인 실패: 사용자 정보를 확인해주세요.';
                }
            } catch (error) {
                console.error('관리자 로그인 오류:', error);
                messageElement.style.color = '#d32f2f';
                messageElement.textContent = '오류 발생: 서버 연결에 실패했습니다. (인터넷 연결 또는 GAS URL 확인)';
            }
        }

        // 관리자 로그아웃 처리
        function handleAdminLogout() {
            adminLoggedInUser = null;
            document.getElementById('adminPanel').classList.remove('active');
            document.getElementById('adminLoginForm').classList.add('active');
            document.getElementById('adminLoginMessage').textContent = '로그아웃 되었습니다.';
            document.getElementById('adminNameInput').value = '';
            document.getElementById('adminPhoneInput').value = '';
            document.getElementById('queryNameInput').value = ''; // 조회 폼도 초기화
            document.getElementById('queryPhoneInput').value = '';
            document.getElementById('message').textContent = '';
            document.getElementById('userDataSection').style.display = 'none'; // 사용자 정보 섹션 숨김
        }

        // Apps Script에서 사용자 정보를 조회하는 함수
        async function fetchUserData() {
            if (!adminLoggedInUser) {
                document.getElementById('message').style.color = '#d32f2f';
                document.getElementById('message').textContent = '관리자 로그인 후 이용해주세요.';
                return;
            }

            const name = document.getElementById('queryNameInput').value.trim();
            const phone = document.getElementById('queryPhoneInput').value.trim();
            const messageElement = document.getElementById('message');
            const userDataSection = document.getElementById('userDataSection');
            
            messageElement.textContent = ''; // 메시지 초기화
            userDataSection.style.display = 'none'; // 이전 정보 숨기기

            if (!name || !phone || phone.length !== 8 || !/^[0-9]+$/.test(phone)) {
                messageElement.style.color = '#d32f2f';
                messageElement.textContent = '이름과 비밀번호 8자리를 숫자로 정확히 입력해주세요.';
                return;
            }

            messageElement.style.color = '#555';
            messageElement.textContent = '사용자 정보를 불러오는 중...';

            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `action=getUserData&name=${encodeURIComponent(name)}&phone=${encodeURIComponent(phone)}`
                });

                const result = await response.json();

                if (result.status === 'success' && result.data) {
                    currentUserName = result.data.name; // 전역 변수에 이름 저장
                    currentUserPhone = result.data.phone; // 전역 변수에 전화번호 저장
                    currentUserPoints = result.data.points; // 전역 변수에 현재 포인트 저장
                    currentUserCoins = result.data.coins; // 전역 변수에 현재 코인 저장
                    currentIsAdmin = result.data.isAdmin; // ✅ 전역 변수에 관리자 여부 저장

                    document.getElementById('displayUserName').textContent = result.data.name;
                    document.getElementById('displayUserPhone').textContent = result.data.phone;
                    document.getElementById('displayUserPoints').textContent = result.data.points;
                    document.getElementById('displayUserCoins').textContent = result.data.coins;
                    document.getElementById('displayIsAdmin').textContent = result.data.isAdmin; // ✅ 관리자 여부 표시
                    userDataSection.style.display = 'block'; // 사용자 정보 섹션 표시

                    messageElement.style.color = '#00796b';
                    messageElement.textContent = `${result.data.name}님의 정보를 성공적으로 불러왔습니다.`;

                    // 추가/차감 입력란 초기화
                    document.getElementById('addPointsInput').value = '';
                    document.getElementById('addCoinsInput').value = '';
                    document.getElementById('adminStatusSelect').value = result.data.isAdmin; // ✅ 드롭다운에 현재 관리자 여부 설정

                } else {
                    messageElement.style.color = '#d32f2f';
                    messageElement.textContent = result.message || '사용자 정보를 불러오는데 실패했습니다.';
                }

            } catch (error) {
                console.error('사용자 정보 조회 오류:', error);
                messageElement.style.color = '#d32f2f';
                messageElement.textContent = '사용자 정보를 불러오는 중 서버 오류가 발생했습니다. (인터넷 연결 또는 GAS URL 확인)';
            }
        }

        // 포인트/코인 추가 또는 차감 후 업데이트하는 함수
        async function updateUserStats() {
            if (!adminLoggedInUser) {
                document.getElementById('updateMessage').style.color = '#d32f2f';
                document.getElementById('updateMessage').textContent = '관리자 로그인 후 이용해주세요.';
                return;
            }

            if (!currentUserName || !currentUserPhone) {
                document.getElementById('updateMessage').style.color = '#d32f2f';
                document.getElementById('updateMessage').textContent = '먼저 사용자 정보를 불러와주세요.';
                return;
            }

            const pointsToAddInput = document.getElementById('addPointsInput').value.trim();
            const coinsToAddInput = document.getElementById('addCoinsInput').value.trim();
            const newAdminStatus = document.getElementById('adminStatusSelect').value;
            const updateMessageElement = document.getElementById('updateMessage');
            updateMessageElement.textContent = ''; // 이전 메시지 초기화

            let finalPoints = currentUserPoints;
            let finalCoins = currentUserCoins;
            let finalAdminStatusToSend = currentIsAdmin;

            let hasChanged = false; // 변경사항이 있는지 확인하는 플래그

            // 포인트 변경량 계산 및 적용
            if (pointsToAddInput !== '') {
                const pointsChange = parseInt(pointsToAddInput);
                if (isNaN(pointsChange)) {
                    updateMessageElement.style.color = '#d32f2f';
                    updateMessageElement.textContent = '포인트 변경량은 유효한 숫자여야 합니다.';
                    return;
                }
                finalPoints += pointsChange;
                hasChanged = true;
            }

            // 코인 변경량 계산 및 적용
            if (coinsToAddInput !== '') {
                const coinsChange = parseInt(coinsToAddInput);
                if (isNaN(coinsChange)) {
                    updateMessageElement.style.color = '#d32f2f';
                    updateMessageElement.textContent = '코인 변경량은 유효한 숫자여야 합니다.';
                    return;
                }
                finalCoins += coinsChange;
                hasChanged = true;
            }
            
            // 관리자 여부 변경 확인 및 적용
            if (newAdminStatus && newAdminStatus !== currentIsAdmin) {
                finalAdminStatusToSend = newAdminStatus;
                hasChanged = true;
            }


            // 변경사항이 전혀 없을 경우
            if (!hasChanged) {
                updateMessageElement.style.color = '#d32f2f';
                updateMessageElement.textContent = '변경할 내용이 없습니다.';
                return;
            }

            updateMessageElement.style.color = '#555';
            updateMessageElement.textContent = '정보를 수정하는 중...';

            try {
                const response = await fetch(GAS_WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `action=updateUserData&name=${encodeURIComponent(currentUserName)}&phone=${encodeURIComponent(currentUserPhone)}&newPoints=${encodeURIComponent(finalPoints)}&newCoins=${encodeURIComponent(finalCoins)}&newAdminStatus=${encodeURIComponent(finalAdminStatusToSend)}`
                });

                const result = await response.json();

                if (result.status === 'success' && result.data) {
                    // 성공적으로 업데이트되면 화면의 값도 최신 정보로 갱신
                    currentUserPoints = result.data.points; // 전역 변수 갱신
                    currentUserCoins = result.data.coins;   // 전역 변수 갱신
                    currentIsAdmin = result.data.isAdmin; // 전역 변수 관리자 여부 갱신

                    document.getElementById('displayUserName').textContent = result.data.name; // 이름 업데이트
                    document.getElementById('displayUserPhone').textContent = result.data.phone; // 전화번호 업데이트
                    document.getElementById('displayUserPoints').textContent = result.data.points;
                    document.getElementById('displayUserCoins').textContent = result.data.coins;
                    document.getElementById('displayIsAdmin').textContent = result.data.isAdmin;
                    updateMessageElement.style.color = '#00796b';
                    updateMessageElement.textContent = '사용자 정보가 성공적으로 수정되었습니다!';
                    
                    // 입력 필드 초기화
                    document.getElementById('addPointsInput').value = '';
                    document.getElementById('addCoinsInput').value = '';
                    document.getElementById('adminStatusSelect').value = result.data.isAdmin;

                } else {
                    updateMessageElement.style.color = '#d32f2f';
                    updateMessageElement.textContent = result.message || '정보 수정에 실패했습니다.';
                }

            } catch (error) {
                console.error('포인트/코인 수정 오류:', error);
                updateMessageElement.style.color = '#d32f2f';
                updateMessageElement.textContent = '정보 수정 중 서버 오류가 발생했습니다. (인터넷 연결 또는 GAS URL 확인)';
            }
        }
    </script>
</body>
</html>
