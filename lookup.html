<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>간편 조회</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
    <style>
        body { background-color: #f8f9fa; display: flex; justify-content: center; align-items: center; min-height: 100vh; margin: 0; }
        .container { max-width: 450px; background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
        h2 { text-align: center; margin-bottom: 30px; color: #333; }
        .form-label { font-weight: 500; }
        .btn-primary { background-color: #007bff; border-color: #007bff; }
    </style>
</head>
<body>
    <!-- 공통 스크립트 (APPS_SCRIPT_API_URL 설정 및 navigateTo, callAppsScript 함수 포함) -->
<!-- 모든 HTML 파일의 <head> 태그 내 또는 <body> 태그 직후에 삽입될 공통 스크립트 -->
<script>
  // <<<--- 중요! 여기에 0단계에서 복사한 Apps Script 웹 앱의 "/exec" URL을 붙여넣으세요! ---
  // 예: 'https://script.google.com/macros/s/AKfycbz_SomeRandomChars_xyz/exec'
  const APPS_SCRIPT_API_URL = 'https://script.google.com/macros/s/AKfycbxE3u9aSh1N2GeOLnQ6r2zaXK3cs5Q9Kpdp7uMifC6Q-NW916S9nV9Yp54GLLrK5hEx/exec'; 

  // 페이지 이동 함수 (trafficday.kro.kr 도메인 기준으로 변경됨)
  function navigateTo(page, params = '') {
      let url = 'http://trafficday.kro.kr/'; // <<<--- 주인님의 웹사이트 기본 도메인으로 설정! (꼭 http:// 또는 https:// 포함!)
      switch (page) {
          case 'index':
              url += 'index.html';
              break;
          case 'about': // about.html 페이지 추가 (이전에는 언급 안 됨)
              url += 'about.html';
              break;
          case 'lookup': 
              url += 'lookup.html';
              break;
          case 'mypage':
              url += 'mypage.html';
              break;
          // 이 간소화 버전에서는 login_signup.html, admin.html은 사용하지 않습니다.
          default:
              console.error('클라이언트: 알 수 없는 페이지 요청 -', page);
              return;
      }
      if (params) {
          url += '?' + params; 
      }
      window.location.href = url;
  }

  // Apps Script API를 호출하는 비동기 함수 (JSON 데이터 POST 방식으로 통신)
  async function callAppsScript(functionName, data = {}) {
      try {
          const response = await fetch(APPS_SCRIPT_API_URL, {
              method: 'POST',
              headers: {
                  'Content-Type': 'application/json' // JSON 형태로 데이터 전송
              },
              // 호출할 Apps Script 함수 이름과 전달할 데이터를 JSON 문자열로 변환하여 전송
              body: JSON.stringify({ functionName, data }) 
          });
          
          // HTTP 응답 상태가 성공 (2xx)이 아니면 에러 발생
          if (!response.ok) { 
              const errorBody = await response.text(); 
              console.error('클라이언트: HTTP Error response body:', errorBody);
              throw new Error(`HTTP 통신 실패: ${response.status} ${response.statusText}. 서버 응답: ${errorBody}`);
          }
          
          return await response.json(); // 성공적인 응답을 JSON 형태로 파싱하여 반환
      } catch (error) {
          console.error('클라이언트: Apps Script API 호출 중 치명적 오류 발생:', error);
          throw new Error('네트워크 또는 클라이언트 측 오류: ' + error.message);
      }
  }
</script>

    <div class="container">
        <h2>정보 조회하기</h2>
        <form id="lookupForm">
            <div class="mb-3">
                <label for="userId" class="form-label">아이디</label>
                <input type="text" class="form-control" id="userId" name="userId" required>
            </div>
            <div class="mb-3">
                <label for="personalCode" class="form-label">개인 코드 8자리</label>
                <input type="text" class="form-control" id="personalCode" name="personalCode" required maxlength="8">
            </div>
            <button type="submit" class="btn btn-primary w-100 mb-3">조회</button>
            <button type="button" class="btn btn-outline-secondary w-100" onclick="navigateTo('index')">취소</button>
        </form>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/js/bootstrap.bundle.min.js" integrity="sha384-FKyoEForCGlyvwx9Hj09JcYn3nv7wiPVlz7YYwJrWVcXK/BmnVDxM+D2scQbITxI" crossorigin="anonymous"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // 이전에 조회한 정보가 있다면 미리 채워넣기 (선택 사항)
            const lastUserId = localStorage.getItem('userLookupId');
            const lastPersonalCode = localStorage.getItem('userLookupPersonalCode');
            if (lastUserId) {
                document.getElementById('userId').value = lastUserId;
            }
            if (lastPersonalCode) {
                document.getElementById('personalCode').value = lastPersonalCode;
            }
        });

        document.getElementById('lookupForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const userId = document.getElementById('userId').value.trim();
            const personalCode = document.getElementById('personalCode').value.trim();

            if (!userId || !personalCode) {
                alert('아이디와 개인 코드 8자리를 모두 입력해주세요.');
                return;
            }

            try {
                // Apps Script의 lookupUserData 함수 호출
                const response = await callAppsScript('lookupUserData', { userId: userId, personalCode: personalCode });

                if (response.success) {
                    alert('정보를 성공적으로 조회했습니다!');
                    // 조회된 정보를 localStorage에 저장 (MyPage에서 사용할 수 있도록)
                    localStorage.setItem('userLookedUp', 'yes');
                    localStorage.setItem('userLookupId', userId);
                    localStorage.setItem('userLookupPersonalCode', personalCode);
                    localStorage.setItem('userLookupName', response.user.name);
                    localStorage.setItem('userLookupPoints', response.user.points);
                    localStorage.setItem('userLookupCoins', response.user.coins);
                    
                    navigateTo('mypage'); // 마이페이지로 이동
                } else {
                    alert('조회 실패: ' + response.message);
                }
            } catch (error) {
                alert('서버 통신 오류 발생: ' + error.message);
            }
        });
    </script>
</body>
</html>
